rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: User has specific role
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isSuperAdmin() {
      return hasRole('superAdmin');
    }

    function isOwner() {
      return hasRole('owner');
    }

    // 1. Users Collection
    // - Users can read/write their own profile
    // - SuperAdmins can read/write all
    match /users/{userId} {
      allow read, write: if isAuthenticated() && (request.auth.uid == userId || isSuperAdmin());
    }

    // 2. Venues Collection
    // - Public read (for guest app/landing)
    // - Owners can write their own venue (matched by ownerId)
    // - SuperAdmins can write all
    match /venues/{venueId} {
      allow read: if true;
      allow create: if isAuthenticated(); // Allow creation (e.g. during onboarding)
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid || isSuperAdmin()
      );
    }

    // 3. Visits Collection
    // - Guests (authenticated anonymously or via phone) can create scans
    // - Owners can read visits for their venues
    // - SuperAdmins can read all
    match /visits/{visitId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        // User reading their own visits
        resource.data.guestId == request.auth.uid || 
        // Owner reading visits for their venue (requires checking venue ownership, simpler is checking if user is owner of the venue referenced in visit)
        // For simplicity/performance rules often rely on client queries matching auth.uid, 
        // strictly: check if requester is owner of resource.data.venueId.
        // Doing a get() here might be expensive. For now, we trust the query constraints for Owners.
        isOwner() || isSuperAdmin()
      );
    }

    // 4. Leads Collection (B2B)
    // - Public create from Landing Page (unauthenticated allowed if we want open form, assuming B2B landing might not auth user first)
    // - If B2B form requires no login, we enable public create.
    match /leads/{leadId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }
  }
}
