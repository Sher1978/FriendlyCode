rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: User has specific role
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'guest') == role;
    }

    function isSuperAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'guest') == 'superAdmin';
    }

    function isOwner() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'guest') == 'owner';
    }

    function ownsVenue(venueId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/venues/$(venueId)).data.ownerId == request.auth.uid;
    }

    function isAssignedToVenue(venueId) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('venueId', '') == venueId;
    }

    // 1. Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isSuperAdmin() || (
        isOwner() && (
          // Allow owner to manage users assigned to their venue
          (request.resource.data.venueId != null && ownsVenue(request.resource.data.venueId)) ||
          (resource != null && resource.data.venueId != null && ownsVenue(resource.data.venueId))
        )
      );
    }

    // 2. Venues Collection
    match /venues/{venueId} {
      allow read: if true;
      allow write: if isSuperAdmin() || (isAuthenticated() && (
        // For existing docs: check ownership OR assignment
        (resource != null && (
          resource.data.ownerId == request.auth.uid ||
          isAssignedToVenue(venueId)
        )) ||
        // For new docs: allow create if authenticated (onboarding flow)
        (resource == null)
      ));
    }

    // 3. Visits Collection
    match /visits/{visitId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        resource.data.uid == request.auth.uid ||             
        resource.data.guestEmail == request.auth.token.email || 
        isOwner() || 
        isSuperAdmin()
      );
    }

    // 4. Leads Collection (B2B)
    match /leads/{leadId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }

    // 5. Venue Requests Collection
    match /venue_requests/{requestId} {
      allow create: if isAuthenticated();
      allow read, delete: if isAuthenticated() && (
        request.auth.uid == resource.data.userId ||
        ownsVenue(resource.data.venueId) ||
        isSuperAdmin()
      );
    }
  }
}
