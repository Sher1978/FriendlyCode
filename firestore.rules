rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper: User is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper: User has specific role
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'guest') == role;
    }

    function isSuperAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'guest') == 'superAdmin';
    }

    function isOwner() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', 'guest') == 'owner';
    }

    // 1. Users Collection
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.uid == userId || isSuperAdmin();
    }

    // 2. Venues Collection
    match /venues/{venueId} {
      allow read: if true;
      allow write: if isSuperAdmin() || (isAuthenticated() && (
        // For existing docs: check ownership
        (resource != null && resource.data.ownerId == request.auth.uid) ||
        // For new docs: allow create if authenticated (onboarding flow)
        (resource == null)
      ));
    }

    // 3. Visits Collection
    // - Guests (authenticated anonymously or via phone) can create scans
    // - Owners can read visits for their venues
    // - SuperAdmins can read all
    match /visits/{visitId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && (
        // User reading their own visits
        resource.data.guestId == request.auth.uid || 
        // Owner reading visits for their venue (requires checking venue ownership, simpler is checking if user is owner of the venue referenced in visit)
        // For simplicity/performance rules often rely on client queries matching auth.uid, 
        // strictly: check if requester is owner of resource.data.venueId.
        // Doing a get() here might be expensive. For now, we trust the query constraints for Owners.
        isOwner() || isSuperAdmin()
      );
    }

    // 4. Leads Collection (B2B)
    // - Public create from Landing Page (unauthenticated allowed if we want open form, assuming B2B landing might not auth user first)
    // - If B2B form requires no login, we enable public create.
    match /leads/{leadId} {
      allow create: if true;
      allow read, update, delete: if isSuperAdmin();
    }
  }
}
